<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Abastecimento Hotel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-y: auto;
    }
    html {
      height: 100%;
    }
    .room-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .room-btn:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
    }
    .room-btn:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .counter-btn {
      transition: all 0.15s ease;
    }
    .counter-btn:active {
      transform: scale(0.95);
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .ai-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      display: inline-block;
      margin-left: 8px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
  <div class="container mx-auto px-4 py-8 max-w-7xl"><!-- Header -->
   <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
    <div class="flex justify-between items-start mb-4">
     <div>
      <h1 class="text-4xl font-bold text-indigo-900 mb-2">Gest√£o de Abastecimento Hotel <span class="ai-badge">ü§ñ IA Integrada</span> <span class="ai-badge" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">üé§ Voz</span></h1>
      <p class="text-gray-600">Controle de √°guas e produtos por quarto com reconhecimento inteligente e voz</p>
      <p class="text-xs text-green-600 font-semibold mt-2">‚úÖ Conectado ao Supabase - Dados salvos na nuvem!</p>
     </div>
     <div class="flex gap-3"><button id="voiceBtn" onclick="toggleVoiceRecognition()" class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg hover:from-red-600 hover:to-pink-600 font-semibold transition-colors flex items-center gap-2 shadow-lg"> üé§ Ativar Voz </button> <button onclick="showAdminLogin()" class="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold transition-colors flex items-center gap-2"> üîê Admin </button>
     </div>
    </div><!-- Voice Status -->
    <div id="voiceStatus" class="hidden mt-4 p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border-2 border-red-200">
     <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
       <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div><span class="font-bold text-red-700">üé§ Escutando...</span>
      </div><button onclick="stopVoiceRecognition()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold text-sm"> Parar </button>
     </div>
     <div class="bg-white rounded-lg p-3 mb-2">
      <p class="text-xs text-gray-500 mb-1">Voc√™ disse:</p>
      <p id="voiceTranscript" class="text-gray-800 font-medium min-h-[24px]">Aguardando comando...</p>
     </div>
     <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-3">
      <p class="text-xs font-bold text-purple-900 mb-2">üí° Exemplos de comandos:</p>
      <ul class="text-xs text-gray-700 space-y-1">
       <li>‚Ä¢ "Quarto 110, uma √°gua grande e uma pequena"</li>
       <li>‚Ä¢ "Quarto 205, 10 √°guas de litro e meio"</li>
       <li>‚Ä¢ "Quarto 301, 5 grandes, 3 pequenas e 2 com g√°s"</li>
      </ul>
     </div>
    </div>
   </div><!-- Admin Login Modal -->
   <div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
     <h2 class="text-2xl font-bold text-indigo-900 mb-6">Acesso Administrativo</h2>
     <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Senha</label> <input type="password" id="adminPassword" placeholder="Digite a senha" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" onkeypress="if(event.key === 'Enter') checkAdminPassword()">
     </div>
     <div class="flex gap-3"><button onclick="checkAdminPassword()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold transition-colors"> Entrar </button> <button onclick="closeAdminModal()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold transition-colors"> Cancelar </button>
     </div>
     <p id="adminError" class="text-red-500 text-sm mt-4 hidden">Senha incorreta!</p>
    </div>
   </div><!-- Admin Panel -->
   <div id="adminPanel" class="bg-white rounded-2xl shadow-xl p-8 mb-8 hidden border-4 border-red-500">
    <div class="flex justify-between items-center mb-6">
     <div>
      <h2 class="text-2xl font-bold text-red-600 flex items-center gap-2">üîê Painel Administrativo</h2>
      <p class="text-gray-600 text-sm">Gerenciar estoque, produtos e configura√ß√µes</p>
     </div><button onclick="closeAdminPanel()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold"> Sair </button>
    </div><!-- Tabs -->
    <div class="flex gap-2 mb-6 border-b-2 border-gray-200"><button id="tabStock" onclick="switchTab('stock')" class="px-6 py-3 font-semibold border-b-4 border-red-500 text-red-600"> üì¶ Gerenciar Estoque </button> <button id="tabProducts" onclick="switchTab('products')" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-800"> ‚ûï Cadastrar Produtos </button>
    </div><!-- Stock Management Tab -->
    <div id="stockTab" class="bg-red-50 rounded-xl p-6">
     <h3 class="text-lg font-bold text-gray-800 mb-4">Ajustar Estoque</h3><!-- Text Input for Stock Adjustment -->
     <div class="bg-white rounded-lg p-6 mb-6 border-2 border-purple-200">
      <h4 class="font-bold text-gray-800 mb-2">üí¨ Ajustar Estoque por Texto <span class="ai-badge">ü§ñ IA</span></h4>
      <p class="text-sm text-gray-600 mb-3">Digite de qualquer forma! A IA entende automaticamente:</p>
      <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4">
       <p class="text-sm font-semibold text-gray-800 mb-2">ÔøΩÔøΩ A IA reconhece TUDO:</p>
       <div class="space-y-2">
        <div class="bg-white rounded-lg p-3 border-l-4 border-blue-500">
         <p class="text-sm text-gray-700 font-medium">"20 aguas 1,5 ml e 5 aguas 500ml, e 6 aguas com gas"</p>
         <p class="text-xs text-gray-500 mt-1">‚úì Reconhece com ou sem acentos, pontos, v√≠rgulas</p>
        </div>
        <div class="bg-white rounded-lg p-3 border-l-4 border-green-500">
         <p class="text-sm text-gray-700 font-medium">"preciso 100 grandes 50 pequenas 25 gas"</p>
         <p class="text-xs text-gray-500 mt-1">‚úì Entende contexto sem palavras completas</p>
        </div>
        <div class="bg-white rounded-lg p-3 border-l-4 border-purple-500">
         <p class="text-sm text-gray-700 font-medium">"coloca 200 de litro e meio e 80 gaseificada"</p>
         <p class="text-xs text-gray-500 mt-1">‚úì Reconhece sin√¥nimos e varia√ß√µes naturais</p>
        </div>
       </div>
      </div>
      <div class="relative mb-3"><textarea id="adminChatInput" placeholder="Digite naturalmente... Ex: 20 aguas 1,5 ml e 5 aguas 500ml, e 6 aguas com gas" class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none resize-none" rows="2" onkeypress="if(event.key === 'Enter' &amp;&amp; !event.shiftKey) { event.preventDefault(); processAdminChatInput(); }"></textarea> <button onclick="processAdminChatInput()" class="absolute right-3 bottom-3 px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold transition-colors"> ü§ñ Processar com IA </button>
      </div><!-- Admin Parsed Results -->
      <div id="adminParsedResults" class="hidden p-4 bg-green-50 rounded-lg border-2 border-green-200">
       <h5 class="font-bold text-green-800 mb-2">‚úÖ IA identificou:</h5>
       <div id="adminParsedList" class="space-y-2 mb-3"></div><button onclick="clearAdminParsedResults()" class="text-sm text-green-700 hover:text-green-900 font-semibold"> üîÑ Limpar </button>
      </div>
     </div>
     <h4 class="text-lg font-bold text-gray-800 mb-4">üî¢ Ajuste Manual por Bot√µes</h4>
     <div class="space-y-4" id="stockList"><!-- Stock items will be rendered here -->
     </div>
     <div class="mt-6 pt-6 border-t-2 border-red-200"><button onclick="resetAllStock()" class="w-full px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold transition-colors"> üóëÔ∏è Zerar Todo o Estoque </button>
     </div>
    </div><!-- Products Management Tab -->
    <div id="productsTab" class="hidden bg-red-50 rounded-xl p-6">
     <h3 class="text-lg font-bold text-gray-800 mb-4">Cadastrar Novo Produto</h3>
     <div class="bg-white rounded-lg p-6 mb-6">
      <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Nome do Produto</label> <input type="text" id="newProductName" placeholder="Ex: Refrigerante, Suco, Toalha..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
      </div>
      <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Emoji/√çcone (opcional)</label> <input type="text" id="newProductEmoji" placeholder="ü•§" maxlength="2" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
      </div>
      <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade Inicial</label> <input type="number" id="newProductQuantity" placeholder="0" min="0" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
      </div><button onclick="addNewProduct()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-colors"> ‚ûï Adicionar Produto </button>
     </div>
     <h3 class="text-lg font-bold text-gray-800 mb-4">Produtos Cadastrados</h3>
     <div class="space-y-3" id="productsList">
      <p class="text-gray-500 text-center py-4">Carregando produtos...</p>
     </div>
    </div>
   </div><!-- Room Selection -->
   <div class="bg-gradient-to-br from-white via-purple-50 to-indigo-100 rounded-3xl shadow-2xl p-8 mb-8 border-2 border-indigo-200">
    <div class="flex items-center gap-4 mb-8 pb-6 border-b-2 border-indigo-200">
     <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 via-purple-600 to-pink-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg transform hover:scale-110 transition-transform">
      üè®
     </div>
     <div>
      <h2 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Selecionar Quarto</h2>
      <p class="text-sm text-gray-600 mt-1 font-medium">‚ú® Clique no quarto para registrar abastecimento</p>
     </div>
    </div><!-- Floor 1 -->
    <div class="mb-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl p-8 shadow-2xl border-2 border-blue-400 relative overflow-hidden">
     <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
     <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
     <div class="relative z-10">
      <div class="flex items-center gap-3 mb-6">
       <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg border-2 border-white border-opacity-30">
        1¬∫
       </div>
       <div class="flex-1">
        <h3 class="text-2xl font-bold text-white drop-shadow-lg">Primeiro Andar</h3>
        <p class="text-blue-100 text-sm font-medium">10 quartos dispon√≠veis</p>
       </div><span class="px-4 py-2 bg-white bg-opacity-20 backdrop-blur-sm rounded-full text-white font-bold border border-white border-opacity-30">101-110</span>
      </div>
      <div class="grid grid-cols-5 md:grid-cols-10 gap-4" id="floor1">
      </div>
     </div>
    </div><!-- Floor 2 -->
    <div class="mb-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-3xl p-8 shadow-2xl border-2 border-purple-400 relative overflow-hidden">
     <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
     <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
     <div class="relative z-10">
      <div class="flex items-center gap-3 mb-6">
       <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg border-2 border-white border-opacity-30">
        2¬∫
       </div>
       <div class="flex-1">
        <h3 class="text-2xl font-bold text-white drop-shadow-lg">Segundo Andar</h3>
        <p class="text-purple-100 text-sm font-medium">10 quartos dispon√≠veis</p>
       </div><span class="px-4 py-2 bg-white bg-opacity-20 backdrop-blur-sm rounded-full text-white font-bold border border-white border-opacity-30">201-210</span>
      </div>
      <div class="grid grid-cols-5 md:grid-cols-10 gap-4" id="floor2">
      </div>
     </div>
    </div><!-- Floor 3 -->
    <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-3xl p-8 shadow-2xl border-2 border-pink-400 relative overflow-hidden">
     <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
     <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
     <div class="relative z-10">
      <div class="flex items-center gap-3 mb-6">
       <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg border-2 border-white border-opacity-30">
        3¬∫
       </div>
       <div class="flex-1">
        <h3 class="text-2xl font-bold text-white drop-shadow-lg">Terceiro Andar</h3>
        <p class="text-pink-100 text-sm font-medium">7 quartos dispon√≠veis</p>
       </div><span class="px-4 py-2 bg-white bg-opacity-20 backdrop-blur-sm rounded-full text-white font-bold border border-white border-opacity-30">301-307</span>
      </div>
      <div class="grid grid-cols-5 md:grid-cols-7 gap-4" id="floor3">
      </div>
     </div>
    </div>
   </div><!-- Product Selection (Hidden by default) -->
   <div id="productSection" class="bg-white rounded-2xl shadow-xl p-8 mb-8 hidden">
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-2xl font-bold text-indigo-900">Quarto <span id="selectedRoom"></span></h2><button onclick="cancelSelection()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"> Cancelar </button>
    </div><!-- Mode Toggle -->
    <div class="flex gap-3 mb-6 p-2 bg-gray-100 rounded-lg"><button id="btnChatMode" onclick="switchMode('chat')" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold transition-colors"> üí¨ Entrada por Texto com IA </button> <button id="btnManualMode" onclick="switchMode('manual')" class="flex-1 px-4 py-3 bg-white text-gray-700 rounded-lg font-semibold transition-colors"> üî¢ Entrada Manual </button>
    </div><!-- Chat Mode Input -->
    <div id="chatModeSection" class="mb-6">
     <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 mb-4 border-2 border-purple-200">
      <h3 class="font-bold text-gray-800 mb-2">ü§ñ IA: Digite de qualquer jeito!</h3>
      <p class="text-sm text-gray-600 mb-3">Exemplos do que a IA entende:</p>
      <ul class="text-sm text-gray-600 space-y-1 ml-4">
       <li>‚Ä¢ "20 aguas 1,5 ml e 5 aguas 500ml, e 6 aguas com gas"</li>
       <li>‚Ä¢ "preciso 10 grandes, 5 pequenas e 3 gaseificadas"</li>
       <li>‚Ä¢ "coloca 15 de litro e meio e 8 com gas"</li>
       <li>‚Ä¢ "100 pet grande 50 pet pequena 25 sparkling"</li>
      </ul>
     </div>
     <div class="relative"><textarea id="chatInput" placeholder="Digite naturalmente... A IA vai entender! Ex: 20 aguas 1,5 ml e 5 aguas 500ml, e 6 aguas com gas" class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none resize-none" rows="3" onkeypress="if(event.key === 'Enter' &amp;&amp; !event.shiftKey) { event.preventDefault(); processChatInput(); }"></textarea> <button onclick="processChatInput()" class="absolute right-3 bottom-3 px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold transition-colors"> ü§ñ Processar </button>
     </div><!-- Parsed Results -->
     <div id="parsedResults" class="hidden mt-4 p-4 bg-green-50 rounded-lg border-2 border-green-200">
      <h4 class="font-bold text-green-800 mb-2">‚úÖ IA identificou:</h4>
      <div id="parsedList" class="space-y-2"></div><button onclick="clearParsedResults()" class="mt-3 text-sm text-green-700 hover:text-green-900 font-semibold"> üîÑ Limpar e tentar novamente </button>
     </div>
    </div><!-- Manual Mode -->
    <div id="manualModeSection" class="hidden space-y-6"><!-- Products will be dynamically rendered here -->
    </div><!-- Operator Name -->
    <div class="mt-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Nome do Operador</label> <input type="text" id="operatorName" placeholder="Digite seu nome" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
    </div><!-- Save Button --> <button id="saveBtn" onclick="saveSupply()" class="w-full mt-6 px-6 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold text-lg transition-colors"> Registrar Abastecimento </button>
   </div><!-- Stock Display -->
   <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
    <h2 class="text-2xl font-bold text-indigo-900 mb-6">Estoque Atual</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="stockDisplay"><!-- Stock cards will be dynamically rendered here -->
    </div>
   </div><!-- Daily Report -->
   <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
    <div class="flex justify-between items-start mb-6">
     <div>
      <h2 class="text-2xl font-bold text-indigo-900">üìä Relat√≥rio do Dia</h2>
      <p class="text-gray-600 text-sm mt-1" id="reportDate"></p>
     </div><button onclick="printDailyReport()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold transition-colors flex items-center gap-2"> üñ®Ô∏è Imprimir Relat√≥rio </button>
    </div>
    <div id="dailyReportContent" class="space-y-6"><!-- Ser√° preenchido dinamicamente -->
    </div>
   </div><!-- History -->
   <div class="bg-white rounded-2xl shadow-xl p-8">
    <h2 class="text-2xl font-bold text-indigo-900 mb-6">Hist√≥rico de Abastecimentos</h2>
    <div id="historyList" class="space-y-4">
     <p class="text-gray-500 text-center py-8">Nenhum abastecimento registrado ainda</p>
    </div>
   </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚úÖ CREDENCIAIS CONFIGURADAS - SUPABASE CONECTADO!
    const SUPABASE_URL = 'https://itlyssmzrdabwvlbusiu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bHlzc216cmRhYnd2bGJ1c2l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjcxMzgsImV4cCI6MjA3OTMwMzEzOH0.01f9OK5W76NxY4PHmZm38QPVYiU0nHKzJHk1p0lD3OQ';
    
    // Inicializar cliente Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ==========================================
    // üíæ FUN√á√ïES DO SUPABASE
    // ==========================================

    // GET - Buscar produtos
    async function fetchProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao buscar produtos:', error);
        showToast('Erro ao carregar produtos. Verifique sua conex√£o com Supabase.', 'error');
        return [];
      }
    }

    // POST - Criar produto
    async function createProduct(product) {
      try {
        const { data, error } = await supabase
          .from('products')
          .insert([product])
          .select();
        
        if (error) throw error;
        return { success: true, data: data[0] };
      } catch (error) {
        console.error('Erro ao criar produto:', error);
        return { success: false, error: error.message };
      }
    }

    // DELETE - Deletar produto
    async function deleteProduct(productId) {
      try {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', productId);
        
        if (error) throw error;
        return { success: true };
      } catch (error) {
        console.error('Erro ao deletar produto:', error);
        return { success: false, error: error.message };
      }
    }

    // GET - Buscar abastecimentos
    async function fetchSupplies() {
      try {
        const { data, error } = await supabase
          .from('supplies')
          .select('*')
          .order('timestamp', { ascending: false });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erro ao buscar abastecimentos:', error);
        showToast('Erro ao carregar abastecimentos. Verifique sua conex√£o com Supabase.', 'error');
        return [];
      }
    }

    // POST - Criar abastecimento
    async function createSupply(supply) {
      try {
        const { data, error } = await supabase
          .from('supplies')
          .insert([supply])
          .select();
        
        if (error) throw error;
        await refreshData();
        return { success: true, data: data[0] };
      } catch (error) {
        console.error('Erro ao criar abastecimento:', error);
        return { success: false, error: error.message };
      }
    }

    // DELETE - Deletar abastecimento
    async function deleteSupplyById(supplyId) {
      try {
        const { error } = await supabase
          .from('supplies')
          .delete()
          .eq('id', supplyId);
        
        if (error) throw error;
        await refreshData();
        return { success: true };
      } catch (error) {
        console.error('Erro ao deletar abastecimento:', error);
        return { success: false, error: error.message };
      }
    }

    // ==========================================
    // üì¶ DADOS E ESTADO DA APLICA√á√ÉO
    // ==========================================

    let currentRoom = null;
    let productCounts = {};
    let allSupplies = [];
    let customProducts = [];
    let recognition = null;
    let isListening = false;



    // Atualizar dados da aplica√ß√£o
    async function refreshData() {
      customProducts = await fetchProducts();
      allSupplies = await fetchSupplies();
      updateStockDisplay();
      renderDailyReport();
      renderHistory();
      if (!document.getElementById('adminPanel').classList.contains('hidden')) {
        renderAdminStockList();
      }
    }

    // ==========================================
    // ü§ñ PARSER DE IA
    // ==========================================

    function parseTextInput(text) {
      const results = {};
      customProducts.forEach(p => results[p.id] = 0);

      const normalizedText = text.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[,;.]/g, ' e ')
        .replace(/\s+/g, ' ')
        .trim();

      const keywords1500 = [
        '1.5', '1,5', '15l', '1500', '1500ml', 'um e meio', 'litro e meio',
        'grande', 'grandes', 'garrafa grande', 'garrafas grandes',
        'pet grande', 'pets grandes', 'garrafa maior', 'maior',
        'agua grande', 'aguas grandes', 'agua 1.5', 'agua 1,5'
      ];
      
      const keywords500 = [
        '500', '500ml', 'quinhentos', 'meio litro',
        'pequena', 'pequenas', 'garrafa pequena', 'garrafas pequenas',
        'pet pequena', 'pets pequenas', 'garrafa menor', 'menor',
        'agua pequena', 'aguas pequenas', 'agua 500'
      ];
      
      const keywordsGas = [
        'gas', 'g√°s', 'com gas', 'comgas', 'c/ gas', 'c gas',
        'gaseificada', 'gaseificadas', 'gasosa', 'gasosas',
        'sparkling', 'carbonatada', 'carbonatadas',
        'com bolhas', 'borbulhante',
        'agua com gas', 'aguas com gas', 'agua gas', 'aguas gas'
      ];

      const segments = normalizedText.split(/\s+e\s+/);
      
      segments.forEach(segment => {
        const numberMatch = segment.match(/(\d+)/);
        if (!numberMatch) return;
        
        const quantity = parseInt(numberMatch[1]);
        if (isNaN(quantity) || quantity <= 0) return;
        
        const hasGas = keywordsGas.some(kw => segment.includes(kw));
        const has1500 = keywords1500.some(kw => segment.includes(kw));
        const has500 = keywords500.some(kw => segment.includes(kw));
        
        if (hasGas) {
          results['water_gas_500ml'] += quantity;
        } else if (has1500) {
          results['water_1500ml'] += quantity;
        } else if (has500) {
          results['water_500ml'] += quantity;
        } else {
          if (segment.includes('agua') || segment.includes('garrafa') || segment.includes('pet')) {
            results['water_1500ml'] += quantity;
          }
        }
      });

      if (Object.values(results).every(v => v === 0)) {
        const numbers = normalizedText.match(/\d+/g);
        if (!numbers || numbers.length === 0) return results;
        
        const gasScore = keywordsGas.filter(kw => normalizedText.includes(kw)).length;
        const score1500 = keywords1500.filter(kw => normalizedText.includes(kw)).length;
        const score500 = keywords500.filter(kw => normalizedText.includes(kw)).length;
        
        const parsedNumbers = numbers.map(n => parseInt(n)).filter(n => n > 0);
        
        if (parsedNumbers.length >= 3) {
          if (score1500 > 0) results['water_1500ml'] = parsedNumbers[0];
          if (score500 > 0) results['water_500ml'] = parsedNumbers[1] || 0;
          if (gasScore > 0) results['water_gas_500ml'] = parsedNumbers[2] || 0;
          
          if (score1500 === 0 && score500 === 0 && gasScore === 0) {
            results['water_1500ml'] = parsedNumbers[0];
            results['water_500ml'] = parsedNumbers[1] || 0;
            results['water_gas_500ml'] = parsedNumbers[2] || 0;
          }
        } else if (parsedNumbers.length === 2) {
          if (gasScore > 0) {
            results['water_1500ml'] = parsedNumbers[0];
            results['water_gas_500ml'] = parsedNumbers[1];
          } else {
            results['water_1500ml'] = parsedNumbers[0];
            results['water_500ml'] = parsedNumbers[1];
          }
        } else if (parsedNumbers.length === 1) {
          if (gasScore > score1500 && gasScore > score500) {
            results['water_gas_500ml'] = parsedNumbers[0];
          } else if (score500 > score1500) {
            results['water_500ml'] = parsedNumbers[0];
          } else {
            results['water_1500ml'] = parsedNumbers[0];
          }
        }
      }

      return results;
    }

    // ==========================================
    // üé® FUN√á√ïES DE UI
    // ==========================================

    function initializeProductCounts() {
      productCounts = {};
      customProducts.forEach(product => {
        productCounts[product.id] = 0;
      });
    }

    function generateRoomButtons() {
      const floor1 = document.getElementById('floor1');
      const floor2 = document.getElementById('floor2');
      const floor3 = document.getElementById('floor3');

      for (let i = 101; i <= 110; i++) {
        floor1.appendChild(createRoomButton(i.toString()));
      }

      for (let i = 201; i <= 210; i++) {
        floor2.appendChild(createRoomButton(i.toString()));
      }

      for (let i = 301; i <= 307; i++) {
        floor3.appendChild(createRoomButton(i.toString()));
      }
    }

    function createRoomButton(roomNumber) {
      const btn = document.createElement('button');
      btn.innerHTML = `
        <div class="flex flex-col items-center gap-2 relative">
          <div class="absolute inset-0 bg-white opacity-0 rounded-xl group-hover:opacity-20 transition-opacity"></div>
          <span class="text-3xl drop-shadow-lg">üö™</span>
          <span class="font-bold text-xl drop-shadow-md">${roomNumber}</span>
        </div>
      `;
      btn.className = 'room-btn group px-6 py-6 bg-white bg-opacity-90 backdrop-blur-sm text-gray-800 rounded-2xl hover:bg-opacity-100 hover:scale-105 shadow-xl hover:shadow-2xl border-3 border-white border-opacity-50 transition-all duration-200';
      btn.onclick = () => selectRoom(roomNumber);
      return btn;
    }

    function selectRoom(roomNumber) {
      currentRoom = roomNumber;
      document.getElementById('selectedRoom').textContent = roomNumber;
      document.getElementById('productSection').classList.remove('hidden');
      
      initializeProductCounts();
      renderProductSelection();
      document.getElementById('operatorName').value = '';
      
      document.getElementById('productSection').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelSelection() {
      currentRoom = null;
      document.getElementById('productSection').classList.add('hidden');
    }

    function renderProductSelection() {
      const container = document.getElementById('manualModeSection');
      container.innerHTML = customProducts.map(product => `
        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl">
          <div class="flex items-center gap-4">
            <div class="text-4xl">${product.emoji}</div>
            <div>
              <h3 class="font-bold text-gray-800">${product.name}</h3>
              ${product.description ? `<p class="text-sm text-gray-600">${product.description}</p>` : ''}
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="decrementProduct('${product.id}')" class="counter-btn w-10 h-10 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold text-xl">-</button>
            <span id="count_${product.id}" class="text-2xl font-bold text-gray-800 w-12 text-center">0</span>
            <button onclick="incrementProduct('${product.id}')" class="counter-btn w-10 h-10 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold text-xl">+</button>
          </div>
        </div>
      `).join('');
    }

    function switchMode(mode) {
      const chatSection = document.getElementById('chatModeSection');
      const manualSection = document.getElementById('manualModeSection');
      const chatBtn = document.getElementById('btnChatMode');
      const manualBtn = document.getElementById('btnManualMode');

      if (mode === 'chat') {
        chatSection.classList.remove('hidden');
        manualSection.classList.add('hidden');
        chatBtn.className = 'flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold transition-colors';
        manualBtn.className = 'flex-1 px-4 py-3 bg-white text-gray-700 rounded-lg font-semibold transition-colors';
      } else {
        chatSection.classList.add('hidden');
        manualSection.classList.remove('hidden');
        manualBtn.className = 'flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold transition-colors';
        chatBtn.className = 'flex-1 px-4 py-3 bg-white text-gray-700 rounded-lg font-semibold transition-colors';
      }
    }

    function processChatInput() {
      const input = document.getElementById('chatInput').value.trim();
      
      if (!input) {
        showToast('Digite algo para processar', 'error');
        return;
      }

      const parsed = parseTextInput(input);
      let foundAny = false;

      customProducts.forEach(product => {
        if (parsed[product.id] > 0) {
          productCounts[product.id] = parsed[product.id];
          foundAny = true;
        }
      });

      if (!foundAny) {
        showToast('ü§ñ IA n√£o conseguiu identificar produtos. Tente adicionar n√∫meros e palavras como "grande", "pequena" ou "g√°s"', 'error');
        return;
      }

      updateCountDisplays();
      displayParsedResults(parsed);
      showToast('ü§ñ IA identificou os produtos com sucesso!', 'success');
    }

    function displayParsedResults(parsed) {
      const resultsDiv = document.getElementById('parsedResults');
      const listDiv = document.getElementById('parsedList');
      
      const items = customProducts
        .filter(product => parsed[product.id] > 0)
        .map(product => `
          <div class="flex items-center justify-between bg-white rounded-lg p-3">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${product.emoji}</span>
              <span class="font-semibold text-gray-800">${product.name}</span>
            </div>
            <span class="text-xl font-bold text-green-700">${parsed[product.id]}</span>
          </div>
        `).join('');

      listDiv.innerHTML = items;
      resultsDiv.classList.remove('hidden');
    }

    function clearParsedResults() {
      document.getElementById('parsedResults').classList.add('hidden');
      document.getElementById('chatInput').value = '';
      initializeProductCounts();
      updateCountDisplays();
    }

    function incrementProduct(productId) {
      productCounts[productId]++;
      updateCountDisplays();
    }

    function decrementProduct(productId) {
      if (productCounts[productId] > 0) {
        productCounts[productId]--;
        updateCountDisplays();
      }
    }

    function updateCountDisplays() {
      customProducts.forEach(product => {
        const element = document.getElementById(`count_${product.id}`);
        if (element) {
          element.textContent = productCounts[product.id] || 0;
        }
      });
    }

    async function saveSupply() {
      const operatorName = document.getElementById('operatorName').value.trim();
      
      if (!operatorName) {
        showToast('Por favor, digite o nome do operador', 'error');
        return;
      }

      const total = Object.values(productCounts).reduce((sum, val) => sum + val, 0);
      if (total === 0) {
        showToast('Selecione pelo menos um produto', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      const supplyData = {
        room_number: currentRoom,
        timestamp: new Date().toISOString(),
        operator: operatorName,
        items: customProducts
          .filter(p => productCounts[p.id] > 0)
          .map(p => ({
            product_id: p.id,
            product_name: p.name,
            quantity: productCounts[p.id]
          }))
      };

      const result = await createSupply(supplyData);

      saveBtn.disabled = false;
      saveBtn.innerHTML = 'Registrar Abastecimento';

      if (result.success) {
        showToast('Abastecimento registrado com sucesso!', 'success');
        cancelSelection();
      } else {
        showToast('Erro ao registrar abastecimento', 'error');
      }
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function calculateStock() {
      const stock = {};
      
      customProducts.forEach(product => {
        stock[product.id] = 0;
      });

      allSupplies.forEach(supply => {
        if (supply.items && Array.isArray(supply.items)) {
          supply.items.forEach(item => {
            if (stock.hasOwnProperty(item.product_id)) {
              stock[item.product_id] += item.quantity || 0;
            }
          });
        }
      });

      return stock;
    }

    function updateStockDisplay() {
      const stock = calculateStock();
      const container = document.getElementById('stockDisplay');
      
      const colors = ['from-blue-500 to-blue-600', 'from-cyan-500 to-cyan-600', 'from-teal-500 to-teal-600', 'from-purple-500 to-purple-600', 'from-pink-500 to-pink-600', 'from-orange-500 to-orange-600'];
      
      const lowStockProducts = customProducts.filter(product => {
        const quantity = stock[product.id] || 0;
        return quantity <= 15;
      });

      const existingAlert = document.getElementById('orderAlert');
      if (lowStockProducts.length > 0 && !existingAlert) {
        showOrderAlert(lowStockProducts, stock);
      } else if (lowStockProducts.length === 0 && existingAlert) {
        existingAlert.remove();
      } else if (lowStockProducts.length > 0 && existingAlert) {
        updateOrderAlert(lowStockProducts, stock);
      }
      
      container.innerHTML = customProducts.map((product, index) => {
        const quantity = stock[product.id] || 0;
        const isLow = quantity <= 15;
        const isCritical = quantity <= 5;
        
        let alertBadge = '';
        let cardClass = `bg-gradient-to-br ${colors[index % colors.length]} rounded-xl p-6 text-white`;
        
        if (isCritical) {
          alertBadge = '<div class="absolute top-3 right-3 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse flex items-center gap-1">üö® CR√çTICO</div>';
          cardClass = `bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-6 text-white border-4 border-red-300 shadow-xl`;
        } else if (isLow) {
          alertBadge = '<div class="absolute top-3 right-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">‚ö†Ô∏è BAIXO</div>';
          cardClass = `bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white border-2 border-yellow-300 shadow-lg`;
        }
        
        return `
          <div class="${cardClass} relative">
            ${alertBadge}
            <div class="text-5xl mb-3">${product.emoji}</div>
            <h3 class="text-lg font-semibold mb-1">${product.name}</h3>
            <p class="text-4xl font-bold">${quantity}</p>
            <p class="text-sm opacity-90 mt-1">unidades em estoque</p>
            ${isCritical ? '<p class="text-xs font-bold mt-2 bg-white bg-opacity-20 rounded px-2 py-1">üî¥ Reabastecer urgente!</p>' : ''}
            ${isLow && !isCritical ? '<p class="text-xs font-bold mt-2 bg-white bg-opacity-20 rounded px-2 py-1">üü° Estoque baixo</p>' : ''}
          </div>
        `;
      }).join('');
    }

    function showOrderAlert(lowStockProducts, stock) {
      const alertDiv = document.createElement('div');
      alertDiv.id = 'orderAlert';
      alertDiv.className = 'fixed bottom-6 right-6 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-2xl shadow-2xl p-6 max-w-md z-50 animate-pulse';
      
      const productList = lowStockProducts.map(product => {
        const quantity = stock[product.id] || 0;
        const isCritical = quantity <= 5;
        return `
          <div class="flex items-center justify-between py-2 border-b border-white border-opacity-30">
            <div class="flex items-center gap-2">
              <span class="text-2xl">${product.emoji}</span>
              <span class="font-semibold">${product.name}</span>
            </div>
            <span class="font-bold ${isCritical ? 'text-red-200' : 'text-yellow-200'}">${quantity} ${isCritical ? 'üö®' : '‚ö†Ô∏è'}</span>
          </div>
        `;
      }).join('');
      
      alertDiv.innerHTML = `
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="text-3xl">üì¶</span>
            <h3 class="text-xl font-bold">Alerta de Pedido!</h3>
          </div>
          <button onclick="closeOrderAlert()" class="text-white hover:text-gray-200 text-2xl font-bold leading-none">&times;</button>
        </div>
        <p class="text-sm mb-4 opacity-90">Os seguintes produtos precisam ser reabastecidos:</p>
        <div class="bg-white bg-opacity-10 rounded-lg p-3 mb-4">
          ${productList}
        </div>
        <button onclick="generateOrderList()" class="w-full bg-white text-orange-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-center gap-2">
          üìã Gerar Lista de Pedido
        </button>
      `;
      
      document.body.appendChild(alertDiv);
    }

    function updateOrderAlert(lowStockProducts, stock) {
      const existingAlert = document.getElementById('orderAlert');
      if (!existingAlert) return;
      
      const productList = lowStockProducts.map(product => {
        const quantity = stock[product.id] || 0;
        const isCritical = quantity <= 5;
        return `
          <div class="flex items-center justify-between py-2 border-b border-white border-opacity-30">
            <div class="flex items-center gap-2">
              <span class="text-2xl">${product.emoji}</span>
              <span class="font-semibold">${product.name}</span>
            </div>
            <span class="font-bold ${isCritical ? 'text-red-200' : 'text-yellow-200'}">${quantity} ${isCritical ? 'üö®' : '‚ö†Ô∏è'}</span>
          </div>
        `;
      }).join('');
      
      const listContainer = existingAlert.querySelector('.bg-white.bg-opacity-10');
      if (listContainer) {
        listContainer.innerHTML = productList;
      }
    }

    function closeOrderAlert() {
      const alert = document.getElementById('orderAlert');
      if (alert) {
        alert.remove();
      }
    }

    function generateOrderList() {
      const stock = calculateStock();
      const lowStockProducts = customProducts.filter(product => {
        const quantity = stock[product.id] || 0;
        return quantity <= 15;
      });

      if (lowStockProducts.length === 0) {
        showToast('Nenhum produto com estoque baixo', 'error');
        return;
      }

      let orderText = 'üìã LISTA DE PEDIDO - HOTEL\n';
      orderText += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
      orderText += `Data: ${new Date().toLocaleDateString('pt-BR')}\n`;
      orderText += `Hora: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n\n`;
      orderText += 'PRODUTOS COM ESTOQUE BAIXO:\n\n';

      lowStockProducts.forEach(product => {
        const quantity = stock[product.id] || 0;
        const status = quantity <= 5 ? 'üö® CR√çTICO' : '‚ö†Ô∏è BAIXO';
        const suggested = quantity <= 5 ? 200 : 100;
        
        orderText += `${product.emoji} ${product.name}\n`;
        orderText += `   Atual: ${quantity} unidades ${status}\n`;
        orderText += `   Sugerido: ${suggested} unidades\n\n`;
      });

      orderText += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅÔøΩÔøΩÔøΩ‚îÅ\n';
      orderText += 'Gerado automaticamente pelo sistema';

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full max-h-[80%] overflow-y-auto">
          <div class="flex justify-between items-start mb-6">
            <h2 class="text-3xl font-bold text-orange-600 flex items-center gap-2">
              üìã Lista de Pedido
            </h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold leading-none">&times;</button>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-6 mb-6 font-mono text-sm whitespace-pre-wrap border-2 border-gray-200">
${orderText}
          </div>

          <div class="flex gap-3">
            <button onclick="copyOrderList(\`${orderText.replace(/`/g, '\\`')}\`)" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition-colors flex items-center justify-center gap-2">
              üìã Copiar Lista
            </button>
            <button onclick="printOrderList(\`${orderText.replace(/`/g, '\\`')}\`)" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-colors flex items-center justify-center gap-2">
              üñ®Ô∏è Imprimir
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function copyOrderList(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('üìã Lista copiada para a √°rea de transfer√™ncia!', 'success');
      }).catch(() => {
        showToast('Erro ao copiar lista', 'error');
      });
    }

    function printOrderList(text) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Lista de Pedido - Hotel</title>
            <style>
              body {
                font-family: 'Courier New', monospace;
                padding: 40px;
                max-width: 800px;
                margin: 0 auto;
              }
              pre {
                white-space: pre-wrap;
                font-size: 14px;
                line-height: 1.6;
              }
            </style>
          </head>
          <body>
            <pre>${text}</pre>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    function renderAdminStockList() {
      const stock = calculateStock();
      const container = document.getElementById('stockList');
      
      container.innerHTML = customProducts.map(product => `
        <div class="flex items-center justify-between">
          <span class="font-semibold text-gray-700">${product.emoji} ${product.name}</span>
          <div class="flex items-center gap-3">
            <button onclick="adjustStock('${product.id}', -10)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold">-10</button>
            <button onclick="adjustStock('${product.id}', -1)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold">-1</button>
            <span id="admin_stock_${product.id}" class="text-xl font-bold text-gray-800 w-16 text-center">${stock[product.id] || 0}</span>
            <button onclick="adjustStock('${product.id}', 1)" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold">+1</button>
            <button onclick="adjustStock('${product.id}', 10)" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold">+10</button>
          </div>
        </div>
      `).join('');
    }

    function renderProductsList() {
      const container = document.getElementById('productsList');
      
      if (customProducts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum produto cadastrado</p>';
        return;
      }

      container.innerHTML = customProducts.map((product, index) => `
        <div class="bg-white rounded-lg p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-3xl">${product.emoji}</span>
            <div>
              <h4 class="font-bold text-gray-800">${product.name}</h4>
              ${product.description ? `<p class="text-sm text-gray-600">${product.description}</p>` : ''}
            </div>
          </div>
          ${index >= 3 ? `
            <button onclick="deleteProductById('${product.id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold">
              Excluir
            </button>
          ` : '<span class="text-xs text-gray-500 px-4">Produto padr√£o</span>'}
        </div>
      `).join('');
    }

    async function addNewProduct() {
      const name = document.getElementById('newProductName').value.trim();
      const emoji = document.getElementById('newProductEmoji').value.trim() || 'ÔøΩÔøΩ';
      const quantity = parseInt(document.getElementById('newProductQuantity').value) || 0;

      if (!name) {
        showToast('Digite o nome do produto', 'error');
        return;
      }

      const productId = 'custom_' + Date.now();
      
      const newProduct = {
        id: productId,
        name: name,
        emoji: emoji,
        description: ''
      };

      const productResult = await createProduct(newProduct);
      
      if (!productResult.success) {
        showToast('Erro ao cadastrar produto', 'error');
        return;
      }

      if (quantity > 0) {
        const adjustData = {
          room_number: 'ADMIN-CADASTRO',
          timestamp: new Date().toISOString(),
          operator: 'Administrador',
          items: [{
            product_id: productId,
            product_name: name,
            quantity: quantity
          }]
        };

        await createSupply(adjustData);
      } else {
        await refreshData();
      }

      document.getElementById('newProductName').value = '';
      document.getElementById('newProductEmoji').value = '';
      document.getElementById('newProductQuantity').value = '';

      renderProductsList();
      renderProductSelection();

      showToast('Produto cadastrado com sucesso!', 'success');
    }

    async function deleteProductById(productId) {
      const productIndex = customProducts.findIndex(p => p.id === productId);
      
      if (productIndex < 3) {
        showToast('N√£o √© poss√≠vel excluir produtos padr√£o', 'error');
        return;
      }

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
          <h3 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Confirmar Exclus√£o</h3>
          <p class="text-gray-700 mb-6">Tem certeza que deseja excluir este produto? Os registros hist√≥ricos ser√£o mantidos.</p>
          <div class="flex gap-3">
            <button id="confirmDelete" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold transition-colors">
              Sim, Excluir
            </button>
            <button id="cancelDelete" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold transition-colors">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);

      document.getElementById('cancelDelete').onclick = () => {
        confirmDiv.remove();
      };

      document.getElementById('confirmDelete').onclick = async () => {
        const result = await deleteProduct(productId);
        
        if (result.success) {
          await refreshData();
          renderProductsList();
          renderProductSelection();
          showToast('Produto exclu√≠do com sucesso!', 'success');
        } else {
          showToast('Erro ao excluir produto', 'error');
        }
        
        confirmDiv.remove();
      };
    }

    function showAdminLogin() {
      document.getElementById('adminModal').classList.remove('hidden');
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminError').classList.add('hidden');
      setTimeout(() => document.getElementById('adminPassword').focus(), 100);
    }

    function closeAdminModal() {
      document.getElementById('adminModal').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
    }

    function checkAdminPassword() {
      const password = document.getElementById('adminPassword').value;
      const errorMsg = document.getElementById('adminError');
      
      if (password === '12345') {
        closeAdminModal();
        openAdminPanel();
      } else {
        errorMsg.classList.remove('hidden');
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      }
    }

    function openAdminPanel() {
      document.getElementById('adminPanel').classList.remove('hidden');
      renderAdminStockList();
      renderProductsList();
      document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function closeAdminPanel() {
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function switchTab(tab) {
      const stockTab = document.getElementById('stockTab');
      const productsTab = document.getElementById('productsTab');
      const stockBtn = document.getElementById('tabStock');
      const productsBtn = document.getElementById('tabProducts');

      if (tab === 'stock') {
        stockTab.classList.remove('hidden');
        productsTab.classList.add('hidden');
        stockBtn.className = 'px-6 py-3 font-semibold border-b-4 border-red-500 text-red-600';
        productsBtn.className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-800';
        renderAdminStockList();
      } else {
        stockTab.classList.add('hidden');
        productsTab.classList.remove('hidden');
        productsBtn.className = 'px-6 py-3 font-semibold border-b-4 border-red-500 text-red-600';
        stockBtn.className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-800';
        renderProductsList();
      }
    }

    function processAdminChatInput() {
      const input = document.getElementById('adminChatInput').value.trim();
      
      if (!input) {
        showToast('Digite algo para processar', 'error');
        return;
      }

      const parsed = parseTextInput(input);
      let foundAny = false;

      customProducts.forEach(product => {
        if (parsed[product.id] > 0) {
          foundAny = true;
        }
      });

      if (!foundAny) {
        showToast('ü§ñ IA n√£o conseguiu identificar produtos. Tente adicionar n√∫meros e palavras como "grande", "pequena" ou "g√°s"', 'error');
        return;
      }

      displayAdminParsedResults(parsed);
      showToast('ü§ñ IA identificou! Clique em "Aplicar Ajustes" para confirmar.', 'success');
    }

    function displayAdminParsedResults(parsed) {
      const resultsDiv = document.getElementById('adminParsedResults');
      const listDiv = document.getElementById('adminParsedList');
      
      const items = customProducts
        .filter(product => parsed[product.id] > 0)
        .map(product => `
          <div class="flex items-center justify-between bg-white rounded-lg p-3">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${product.emoji}</span>
              <span class="font-semibold text-gray-800">${product.name}</span>
            </div>
            <span class="text-xl font-bold text-green-700">+${parsed[product.id]}</span>
          </div>
        `).join('');

      listDiv.innerHTML = items + `
        <button onclick="applyAdminAdjustments(${JSON.stringify(parsed).replace(/"/g, '&quot;')})" class="w-full mt-3 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-colors">
          ‚úÖ Aplicar Ajustes ao Estoque
        </button>
      `;
      
      resultsDiv.classList.remove('hidden');
    }

    async function applyAdminAdjustments(parsed) {
      const adjustItems = customProducts
        .filter(p => parsed[p.id] > 0)
        .map(p => ({
          product_id: p.id,
          product_name: p.name,
          quantity: parsed[p.id]
        }));

      const adjustData = {
        room_number: 'ADMIN-AJUSTE-TEXTO',
        timestamp: new Date().toISOString(),
        operator: 'Administrador',
        items: adjustItems
      };

      const result = await createSupply(adjustData);

      if (result.success) {
        showToast('Estoque ajustado com sucesso!', 'success');
        clearAdminParsedResults();
      } else {
        showToast('Erro ao ajustar estoque', 'error');
      }
    }

    function clearAdminParsedResults() {
      document.getElementById('adminParsedResults').classList.add('hidden');
      document.getElementById('adminChatInput').value = '';
    }

    async function adjustStock(productId, amount) {
      const product = customProducts.find(p => p.id === productId);
      if (!product) return;

      const adjustData = {
        room_number: 'ADMIN-AJUSTE',
        timestamp: new Date().toISOString(),
        operator: 'Administrador',
        items: [{
          product_id: productId,
          product_name: product.name,
          quantity: amount
        }]
      };

      const result = await createSupply(adjustData);

      if (result.success) {
        showToast('Estoque ajustado com sucesso!', 'success');
      } else {
        showToast('Erro ao ajustar estoque', 'error');
      }
    }

    async function resetAllStock() {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
          <h3 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Confirmar A√ß√£o</h3>
          <p class="text-gray-700 mb-6">Tem certeza que deseja ZERAR TODO O ESTOQUE? Esta a√ß√£o n√£o pode ser desfeita.</p>
          <div class="flex gap-3">
            <button id="confirmReset" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold transition-colors">
              Sim, Zerar Tudo
            </button>
            <button id="cancelReset" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold transition-colors">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);

      document.getElementById('cancelReset').onclick = () => {
        confirmDiv.remove();
      };

      document.getElementById('confirmReset').onclick = async () => {
        const confirmBtn = document.getElementById('confirmReset');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

        for (const supply of allSupplies) {
          await deleteSupplyById(supply.id);
        }

        confirmDiv.remove();
        showToast('Todo o estoque foi zerado!', 'success');
      };
    }

    function renderDailyReport() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todaySupplies = allSupplies.filter(supply => {
        const supplyDate = new Date(supply.timestamp);
        supplyDate.setHours(0, 0, 0, 0);
        return supplyDate.getTime() === today.getTime();
      });

      document.getElementById('reportDate').textContent = 
        `Data: ${today.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

      const reportContent = document.getElementById('dailyReportContent');

      if (todaySupplies.length === 0) {
        reportContent.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum abastecimento registrado hoje</p>';
        return;
      }

      // Calcular totais por produto
      const totals = {};
      customProducts.forEach(p => totals[p.id] = 0);

      todaySupplies.forEach(supply => {
        if (supply.items && Array.isArray(supply.items)) {
          supply.items.forEach(item => {
            if (totals.hasOwnProperty(item.product_id)) {
              totals[item.product_id] += item.quantity || 0;
            }
          });
        }
      });

      // Resumo geral
      const summaryHTML = `
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 border-2 border-indigo-200">
          <h3 class="text-lg font-bold text-indigo-900 mb-4">üì¶ Resumo do Dia</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            ${customProducts.map(product => {
              const qty = totals[product.id];
              if (qty === 0) return '';
              return `
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                  <div class="text-3xl mb-2">${product.emoji}</div>
                  <p class="text-sm text-gray-600 font-semibold">${product.name}</p>
                  <p class="text-2xl font-bold text-indigo-600">${qty}</p>
                </div>
              `;
            }).join('')}
          </div>
          <div class="mt-4 pt-4 border-t-2 border-indigo-200 text-center">
            <p class="text-sm text-gray-600">
              <span class="font-bold text-indigo-900">${todaySupplies.length}</span> abastecimentos realizados hoje
            </p>
          </div>
        </div>
      `;

      // Detalhamento por quarto
      const sortedSupplies = [...todaySupplies].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      const detailsHTML = `
        <div>
          <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Detalhamento por Quarto</h3>
          <div class="space-y-3">
            ${sortedSupplies.map(supply => {
              const date = new Date(supply.timestamp);
              const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
              
              const itemsText = supply.items && Array.isArray(supply.items) ?
                supply.items.map(item => {
                  const product = customProducts.find(p => p.id === item.product_id);
                  return product ? `${product.emoji} ${item.quantity} ${product.name}` : '';
                }).filter(Boolean).join(' ‚Ä¢ ') : '';
              
              return `
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-indigo-500">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="font-bold text-indigo-900 text-lg">Quarto ${supply.room_number}</span>
                        <span class="text-sm text-gray-500">${timeStr}</span>
                      </div>
                      <p class="text-sm text-gray-700 mb-2">Operador: <span class="font-semibold">${supply.operator}</span></p>
                      <p class="text-sm text-gray-800">${itemsText}</p>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      reportContent.innerHTML = summaryHTML + detailsHTML;
    }

    function printDailyReport() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todaySupplies = allSupplies.filter(supply => {
        const supplyDate = new Date(supply.timestamp);
        supplyDate.setHours(0, 0, 0, 0);
        return supplyDate.getTime() === today.getTime();
      });

      if (todaySupplies.length === 0) {
        showToast('Nenhum abastecimento registrado hoje', 'error');
        return;
      }

      // Calcular totais
      const totals = {};
      customProducts.forEach(p => totals[p.id] = 0);

      todaySupplies.forEach(supply => {
        if (supply.items && Array.isArray(supply.items)) {
          supply.items.forEach(item => {
            if (totals.hasOwnProperty(item.product_id)) {
              totals[item.product_id] += item.quantity || 0;
            }
          });
        }
      });

      const sortedSupplies = [...todaySupplies].sort((a, b) => 
        new Date(a.timestamp) - new Date(b.timestamp)
      );

      const dateStr = today.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Relat√≥rio de Abastecimento - ${today.toLocaleDateString('pt-BR')}</title>
            <style>
              @media print {
                @page {
                  margin: 2cm;
                }
              }
              body {
                font-family: Arial, sans-serif;
                padding: 20px;
                max-width: 1000px;
                margin: 0 auto;
                color: #333;
              }
              .header {
                text-align: center;
                border-bottom: 3px solid #4F46E5;
                padding-bottom: 20px;
                margin-bottom: 30px;
              }
              .header h1 {
                color: #4F46E5;
                margin: 0 0 10px 0;
                font-size: 28px;
              }
              .header p {
                margin: 5px 0;
                color: #666;
                font-size: 14px;
              }
              .summary {
                background: #F3F4F6;
                border: 2px solid #E5E7EB;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
              }
              .summary h2 {
                color: #4F46E5;
                margin-top: 0;
                margin-bottom: 15px;
                font-size: 20px;
              }
              .summary-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-bottom: 15px;
              }
              .summary-item {
                background: white;
                border: 1px solid #E5E7EB;
                border-radius: 6px;
                padding: 15px;
                text-align: center;
              }
              .summary-item .emoji {
                font-size: 24px;
                margin-bottom: 8px;
              }
              .summary-item .name {
                font-size: 13px;
                color: #666;
                font-weight: 600;
                margin-bottom: 5px;
              }
              .summary-item .quantity {
                font-size: 24px;
                font-weight: bold;
                color: #4F46E5;
              }
              .summary-footer {
                border-top: 2px solid #E5E7EB;
                padding-top: 15px;
                text-align: center;
                font-weight: bold;
                color: #4F46E5;
              }
              .details {
                margin-top: 30px;
              }
              .details h2 {
                color: #4F46E5;
                margin-bottom: 15px;
                font-size: 20px;
              }
              .supply-item {
                border: 1px solid #E5E7EB;
                border-left: 4px solid #4F46E5;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 10px;
                background: #F9FAFB;
                page-break-inside: avoid;
              }
              .supply-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              }
              .supply-room {
                font-size: 18px;
                font-weight: bold;
                color: #4F46E5;
              }
              .supply-time {
                font-size: 13px;
                color: #666;
              }
              .supply-operator {
                font-size: 13px;
                color: #666;
                margin-bottom: 8px;
              }
              .supply-items {
                font-size: 14px;
                color: #333;
              }
              .footer {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 2px solid #E5E7EB;
                text-align: center;
                font-size: 12px;
                color: #999;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üè® RELAT√ìRIO DE ABASTECIMENTO</h1>
              <p>${dateStr.toUpperCase()}</p>
              <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
            </div>

            <div class="summary">
              <h2>üì¶ RESUMO DO DIA</h2>
              <div class="summary-grid">
                ${customProducts.map(product => {
                  const qty = totals[product.id];
                  if (qty === 0) return '';
                  return `
                    <div class="summary-item">
                      <div class="emoji">${product.emoji}</div>
                      <div class="name">${product.name}</div>
                      <div class="quantity">${qty}</div>
                    </div>
                  `;
                }).join('')}
              </div>
              <div class="summary-footer">
                Total de ${todaySupplies.length} abastecimentos realizados
              </div>
            </div>

            <div class="details">
              <h2>üìã DETALHAMENTO POR QUARTO</h2>
              ${sortedSupplies.map(supply => {
                const date = new Date(supply.timestamp);
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const itemsText = supply.items && Array.isArray(supply.items) ?
                  supply.items.map(item => {
                    const product = customProducts.find(p => p.id === item.product_id);
                    return product ? `${product.emoji} ${item.quantity} ${product.name}` : '';
                  }).filter(Boolean).join(' ‚Ä¢ ') : '';
                
                return `
                  <div class="supply-item">
                    <div class="supply-header">
                      <span class="supply-room">Quarto ${supply.room_number}</span>
                      <span class="supply-time">${timeStr}</span>
                    </div>
                    <div class="supply-operator">Operador: ${supply.operator}</div>
                    <div class="supply-items">${itemsText}</div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="footer">
              <p>Sistema de Gest√£o de Abastecimento Hotel</p>
              <p>Este documento foi gerado automaticamente</p>
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
      
      setTimeout(() => {
        printWindow.print();
      }, 250);
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      
      if (allSupplies.length === 0) {
        historyList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum abastecimento registrado ainda</p>';
        return;
      }

      const sortedSupplies = [...allSupplies].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      historyList.innerHTML = sortedSupplies.map(supply => {
        const date = new Date(supply.timestamp);
        const dateStr = date.toLocaleDateString('pt-BR');
        const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        const items = supply.items && Array.isArray(supply.items) ? 
          supply.items.map(item => {
            const product = customProducts.find(p => p.id === item.product_id);
            if (!product) return '';
            
            return `
              <div class="bg-blue-50 rounded-lg p-3 text-center">
                <div class="text-2xl mb-1">${product.emoji}</div>
                <p class="text-sm text-gray-600">${product.name}</p>
                <p class="text-xl font-bold text-gray-800">${item.quantity}</p>
              </div>
            `;
          }).join('') : '';
        
        return `
          <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-indigo-300 transition-colors">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-indigo-900">Quarto ${supply.room_number}</h3>
                <p class="text-sm text-gray-600">${dateStr} √†s ${timeStr}</p>
                <p class="text-sm text-gray-700 mt-1">Por: <span class="font-semibold">${supply.operator}</span></p>
              </div>
              <button onclick="deleteSupplyRecord('${supply.id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold">
                Excluir
              </button>
            </div>
            <div class="grid grid-cols-3 gap-4">
              ${items}
            </div>
          </div>
        `;
      }).join('');
    }

    async function deleteSupplyRecord(supplyId) {
      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Excluindo...';

      const result = await deleteSupplyById(supplyId);

      if (!result.success) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Excluir';
        showToast('Erro ao excluir registro', 'error');
      }
    }

    // ==========================================
    // üé§ RECONHECIMENTO DE VOZ (ASR)
    // ==========================================

    function initVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        showToast('Reconhecimento de voz n√£o dispon√≠vel neste navegador', 'error');
        return false;
      }

      recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onstart = () => {
        isListening = true;
        document.getElementById('voiceStatus').classList.remove('hidden');
        document.getElementById('voiceBtn').innerHTML = 'üé§ Voz Ativa';
        document.getElementById('voiceBtn').className = 'px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 font-semibold transition-colors flex items-center gap-2 shadow-lg';
        document.getElementById('voiceTranscript').textContent = 'Aguardando comando...';
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        const displayText = finalTranscript || interimTranscript;
        document.getElementById('voiceTranscript').textContent = displayText;

        if (finalTranscript) {
          processVoiceCommand(finalTranscript.trim());
        }
      };

      recognition.onerror = (event) => {
        console.error('Erro no reconhecimento de voz:', event.error);
        if (event.error === 'no-speech') {
          document.getElementById('voiceTranscript').textContent = 'Nenhuma fala detectada...';
        } else if (event.error === 'not-allowed') {
          showToast('Permiss√£o de microfone negada', 'error');
          stopVoiceRecognition();
        } else {
          showToast('Erro no reconhecimento de voz', 'error');
        }
      };

      recognition.onend = () => {
        if (isListening) {
          recognition.start();
        }
      };

      return true;
    }

    function toggleVoiceRecognition() {
      if (!recognition) {
        if (!initVoiceRecognition()) {
          return;
        }
      }

      if (isListening) {
        stopVoiceRecognition();
      } else {
        startVoiceRecognition();
      }
    }

    function startVoiceRecognition() {
      try {
        recognition.start();
        showToast('üé§ Reconhecimento de voz ativado', 'success');
      } catch (error) {
        console.error('Erro ao iniciar reconhecimento:', error);
      }
    }

    function stopVoiceRecognition() {
      isListening = false;
      if (recognition) {
        recognition.stop();
      }
      document.getElementById('voiceStatus').classList.add('hidden');
      document.getElementById('voiceBtn').innerHTML = 'üé§ Ativar Voz';
      document.getElementById('voiceBtn').className = 'px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg hover:from-red-600 hover:to-pink-600 font-semibold transition-colors flex items-center gap-2 shadow-lg';
      showToast('üé§ Reconhecimento de voz desativado', 'success');
    }

    function processVoiceCommand(transcript) {
      const normalized = transcript.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '');

      // Extrair n√∫mero do quarto
      const roomMatch = normalized.match(/quarto\s*(\d{3})/);
      if (!roomMatch) {
        showToast('üé§ N√£o entendi o n√∫mero do quarto. Diga "quarto" seguido do n√∫mero', 'error');
        return;
      }

      const roomNumber = roomMatch[1];
      
      // Verificar se o quarto existe
      const validRooms = [];
      for (let i = 101; i <= 110; i++) validRooms.push(i.toString());
      for (let i = 201; i <= 210; i++) validRooms.push(i.toString());
      for (let i = 301; i <= 307; i++) validRooms.push(i.toString());
      
      if (!validRooms.includes(roomNumber)) {
        showToast(`üé§ Quarto ${roomNumber} n√£o existe`, 'error');
        return;
      }

      // Extrair produtos (tudo depois do n√∫mero do quarto)
      const afterRoom = normalized.split(/quarto\s*\d{3}/)[1];
      if (!afterRoom || afterRoom.trim().length === 0) {
        showToast('üé§ N√£o entendi quais produtos. Diga quantidades e tipos', 'error');
        return;
      }

      // Selecionar o quarto
      selectRoom(roomNumber);

      // Usar o parser de IA para identificar produtos
      const parsed = parseTextInput(afterRoom);
      
      let foundAny = false;
      customProducts.forEach(product => {
        if (parsed[product.id] > 0) {
          productCounts[product.id] = parsed[product.id];
          foundAny = true;
        }
      });

      if (!foundAny) {
        showToast('üé§ N√£o consegui identificar os produtos. Tente novamente', 'error');
        return;
      }

      // Atualizar displays
      updateCountDisplays();
      
      // Mostrar sucesso
      const productsText = customProducts
        .filter(p => productCounts[p.id] > 0)
        .map(p => `${productCounts[p.id]} ${p.name}`)
        .join(', ');
      
      showToast(`üé§ ‚úÖ Quarto ${roomNumber}: ${productsText}`, 'success');

      // Scroll para a se√ß√£o de produtos
      document.getElementById('productSection').scrollIntoView({ behavior: 'smooth' });

      // Mudar para modo manual para visualiza√ß√£o
      switchMode('manual');
    }

    async function init() {
      initializeProductCounts();
      
      await refreshData();
      
      generateRoomButtons();

      // Inicializar reconhecimento de voz
      initVoiceRecognition();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a385e67c11bf61f',t:'MTc2Mzk4MTY3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
